@import "compass/css3/text-shadow";
@import "compass/css3/user-interface";

@mixin jquery-text-shadow-base-styles {
  .ui-text-shadow, .ui-text-shadow-original {
    position: relative;
  }
  .ui-text-shadow-original {
    z-index: 1;
    text-shadow: none;
  }
  .ui-text-shadow-copy {
    position: absolute;
    z-index: 0;
    
    // default positioning
    left: 0;
    top: 0;
    
    // turn off shadow
    text-shadow: none;
    
    // turn off selection
    @include user-select(none);
  }
}

@mixin jquery-text-shadow($shadow: default) {
  @if $shadow == default {
    $shadow: $default-text-shadow-color $default-text-shadow-h-offset $default-text-shadow-v-offset $default-text-shadow-blur;
  }

  $length: length($shadow);
  
  // some defaults
  $color: $default-text-shadow-color;
  $offset-x: 0;
  $offset-y: 0;
  $blur-radius: 0;
  $spread: 0; // IE10 only

  // pull apart the individual arguments from the list
  @if type-of(nth($shadow, 1)) == color {
    // color first, blur, spread optional
    @if $length >= 1 { $color: nth($shadow, 1); }
    @if $length >= 2 { $offset-x: nth($shadow, 2); }
    @if $length >= 3 { $offset-y: nth($shadow, 3); }
    @if $length >= 4 { $blur-radius: nth($shadow, 4); }
    @if $length == 5 { $spread: nth($shadow, 5); }
  } @else {
    // color last or missing, blur optional, spread optional
    @if $length == 5 and type-of(nth($shadow, 5)) == color {
      $color: nth($shadow, 5);
    }
    @if $length == 4 and type-of(nth($shadow, 4)) == color {
      $color: nth($shadow, 4);
    }
    @if $length == 3 and type-of(nth($shadow, 3)) == color {
      $color: nth($shadow, 3);
    }
    @if $length >= 1 { $offset-x: nth($shadow, 1); }
    @if $length >= 2 { $offset-y: nth($shadow, 2); }
    @if $length >= 3 and type-of(nth($shadow, 3)) != color {
      $blur-radius: nth($shadow, 3);
    }
    @if $length >= 4 and type-of(nth($shadow, 4)) != color {
      $spread: nth($shadow, 4);
    }
  }

  // seperate the color from the opacity
  $opacity: round(alpha($color) * 100);
  $color: rgb(red($color), green($color), blue($color));
  
  // remove the unit from the radius
  @if unit($blur-radius) == px {
    $blur-radius: $blur-radius / 1px;
  }

  // for supported browers
  @include text-shadow($shadow);

  // for the jquery text-shadow plugin
  .ui-text-shadow-copy {
    color: $color;
    filter: if($opacity < 100, unquote("progid:DXImageTransform.Microsoft.Alpha(Opacity=#{$opacity})"), unquote(""))
      unquote("progid:DXImageTransform.Microsoft.Blur(makeShadow=false,pixelRadius=#{$blur-radius})");
    left: $offset-x - $blur-radius;
    top: $offset-y - $blur-radius;
  }
}